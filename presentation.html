<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Vilnius.js #15 - File upload</title>

    <meta name="description" content="JavaScript File upload">
    <meta name="author" content="Matas Seimys, Vytautas Jakutis">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.css">
    <link rel="stylesheet" href="bower_components/reveal.js/css/theme/white.css" id="theme">
    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css">
    <style>
        .reveal section img {
            border: 0;
        }
        .reveal pre code {
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .reveal pre {
            width: 100%;
        }
    </style>
</head>
<body>

<div class="reveal">
    <div class="slides">
        <section>
            <h1>File uploads</h1>
            <h5>Vilnius.js Meetup #15</h5>
            <blockquote cite="http://www.azlyrics.com/lyrics/daftpunk/technologic.html" style="font-size: 0.7em;">
                Plug it, play it, burn it, rip it,<br>
                Drag and drop it, zip - unzip it,<br>
                Lock it, fill it, call it, find it,<br>
                View it, code it, jam - unlock it... <br>
                -- <b>Daft Punk &ldquo;Technologic&rdquo;</b>
            </blockquote>
            <p>
                <a href="http://matas.seimys.com">Matas Å eimys</a> <a href="http://twitter.com/mseimys">@mseimys</a>
            </p>
            <p>
                <small>
                    With great help from
                    <a href="https://jakut.is/">Vytautas Jakutis</a> <a href="http://twitter.com/jakutis0">@jakutis0</a>
                </small>
            </p>
        </section>

        <section>
            <p>About me, my company, LaTeX?</p>
        </section>

        <section>
            <h2>File uploads?</h2>
            <p><i>Let me just google it...</i></p>
            <!-- reaction -->
            <ul class="fragment">
                <li>How to do it on my framework X/Y/Z?</li>
                <li>Why so complicated?</li>
                <li>Is this still relevant? Do I need it?</li>
                <li>How should I process that on backend?</li>
            </ul>
        </section>

        <section>
            <h2>File uploads!</h2>
            <p>They are changing with the rest of web technologies</p>
            <p>Quite important, especially in enterprise software</p>
            <p>Sign of quality</p>
            <!-- reaction -->
        </section>

        <section>
            <h2>Old forms for uploading files</h2>
            <table>
                <tr>
                    <td>
                        <small>Picasa and Google docs ~2010</small>
                    </td>
                    <td>
                        <img src="images/picasa-web-upload.png">
                        <img src="images/google_docs_old.jpg">
                    </td>
                </tr>
            </table>
        </section>

        <section>
            <section>
                <h3>Current trends</h3>
                <div>Google Docs image insert</div>
                <img src="images/google_image_insert.jpg">
            </section>
            <section>
                <h3>Current trends</h3>
                <div>Facebook photo and file upload</div>
                <img src="images/facebook_photo_upload.jpg">
                <img src="images/facebook_file_upload.png">
            </section>
            <!--
            <section>
                <h3>Current trends</h3>
                <table><tr><td>
                    <img src="images/aws_upload.jpg">
                </td><td>
                    <img src="images/rackspace_upload.jpg">
                </td></tr></table>
            </section>
            -->
        </section>

        <section>
            <h2>History</h2>
            <div style="text-align: left; margin-left: 50px">
                <p>1993: HTML is born</p>
                <p>1995: <code style="color: #400">&lt;input type="file"&gt;</code> appears</p>
                <p>~2000: AJAX introduced - XMLHttpRequest</p>
                <p>~2010: multiple files can be selected</p>
                <p>2010-2011: HTML5 File API</p>
                <p>2011: WebSockets standardized</p>
            </div>
        </section>

        <section>
            <img class="stretch" src="images/usage_share_of_web_browsers.png">
        </section>

        <section>
            <h2>Future?</h2>
            <ul>
                <li>Less and less files on physical discs</li>
                <li>Upload from cloud of your choice</li>
                <li><code style="color: #400">&lt;input type="cloud"&gt;</code></li>
                <li>Anyone up for writing a nice library?</li>
            </ul>
        </section>

        <section>
            <h2>Web Standards</h2>
            <p>
                <q cite="http://searchservervirtualization.techtarget.com/definition/Our-Favorite-Technology-Quotations">
                    &ldquo;The nice thing about standards is that there are so many to choose from&rdquo;</q>
            </p>
        </section>

        <section>
            <section>
                <h2>Textbook Example</h2>
                        <pre><code class="html" data-trim>
<form method="POST" action="/upload" enctype="multipart/form-data">
    <input type="file" id="myfile" name="myfile">
    <input type="submit" value="Upload" name="submit">
</form>
                        </code></pre>
            </section>
            <section>
                <h4>enctype=<br>"application/x-www-form-urlencoded"</h4>
                <img src="images/x-www-form-urlencoded.png">
                <p>Default, simple encoding: name=value strings separated by ampersands (&amp;) and uses special escape.
                </p>
            </section>
            <section>
                <h4>enctype=<br>"multipart/form-data"</h4>
                <img src="images/multipart-formdata.png">
                <p>Each form field has certain structure and is separated by special boundary. <i>Binary file upload!</i>
                </p>
            </section>
        </section>

        <section>
            <section>
                <h2>Simple Node.js server-side</h2>
                        <pre><code class="javascript stretch" data-trim>
...
var multer = require('multer');

app.use(multer({
    dest: './tmp',
    putSingleFilesInArray: true
}));

app.post('/upload', function (req, res) {
    req.files.myfile.forEach(function(item) {
        // Do something with each file
        console.log(item.originalname + " uploaded to " + item.path);
    });
    res.redirect("back");
});
...
                        </code></pre>
            </section>
            <section>
                <h2>Simple Python server-side</h2>
                        <pre><code class="python stretch" data-trim>
import os
from flask import Flask, request, redirect, url_for
from werkzeug.utils import secure_filename

app = Flask(__name__, static_folder='')

UPLOAD_FOLDER = '/tmp'

@app.route("/upload", methods=['POST'])
def upload():
    for fh in request.files.getlist('myfile'):
        filename = secure_filename(fh.filename)
        fh.save(os.path.join(UPLOAD_FOLDER, filename))
        app.logger.info("Uploaded %s", filename)
    return redirect(url_for('index'))

@app.route("/")
def index():
    return app.send_static_file("0_simple.html")

if __name__ == "__main__":
    app.run(debug=True)
                        </code></pre>
            </section>
            <section>
                <h4>Post/Redirect/Get design pattern</h4>
                <img src="images/post_redirect_get.png">
            </section>
        </section>

        <section>
            <section>
                <h2>Uploading Asynchronously</h2>
                <p style="color:#666;">&lt;!-- here be list of benefits --&gt;</p>
                <img src="reactions/facepalm.gif">
            </section>
            <section>
                <h2>Async Upload</h2>
                    <pre><code class="html stretch" data-trim>
<form method="POST" action="/upload" enctype="multipart/form-data" id="myform">
    <input type="file" id="myfile" name="myfile">
    <button id="upload-file">Upload!</button>
</form>
                    </code></pre>
                    <pre><code class="javascript" data-trim>
$('#upload-file').on('click', function(e){
    e.preventDefault();
    $.post("/upload", $("#myform").serialize(), function(data) {
        // Successfully uploaded data!?
    });
});
                    </code></pre>
                    <p class="fragment">Wrong!</p>
            </section>
            <section>
                <h2>Upload hack: iframe</h2>
                <pre><code class="html stretch" data-trim>
<iframe id="uploadTrg" name="uploadTrg" height="0" width="0" frameborder="0" scrolling="yes"></iframe>
<form method="POST" action="/upload" enctype="multipart/form-data" target="uploadTrg">
    <input type="file" id="myfile" name="myfile">
    <input type="submit" value="Upload" name="submit">
</form>
<script>
    var iframe = document.getElementById('uploadTrg');
    iframe.addEventListener('load', function(){
        alert("The file is uploaded!");
    });
</script>
                </code></pre>
            </section>
        </section>

        <section>
            <section>
                <h2>Drag and drop it</h2>
                <h4>HTML</h4>
                <pre><code class="html" data-trim>
<form method="POST" action="/upload" enctype="multipart/form-data">
    <input type="file" id="myfile" name="myfile">
    <div id="dropzone">
        ... or drop files here.
    </div>
    <input type="submit" value="Upload" name="submit">
</form>
                </code></pre>
            </section>
            <section>
                <h4>Drag and drop: JavaScript</h4>
                <pre><code class="javascript stretch" data-trim>
var dropzone = document.getElementById('dropzone');

function FileDragHover(e) {
    // dropped file is opened in browser by default
    e.stopPropagation();
    e.preventDefault();
    // proper hover styling is really important!!
    e.target.className = (e.type == "dragover" ? "hover" : "");
}

function FileSelectHandler(e) {
    // cancel event and hover styling
    FileDragHover(e);
    // fetch FileList (HTML5) object
    var files = e.target.files || e.dataTransfer.files;
    handleFiles(files);
}

dropzone.addEventListener("dragover", FileDragHover, false);
dropzone.addEventListener("dragenter", FileDragHover, false);
dropzone.addEventListener("drop", FileSelectHandler, false);
                </code></pre>
            </section>
        </section>


        <section>
            <h2>Cross-site file uploads</h2>
            <p>Say you want to upload file to <b>http://yoursharedstorage.com</b></p>
            <p>No changes are needed to client/frontend</p>
            <p>But storage server must reply to POST/OPTIONS with:</p>
            <pre><code data-trim>
Access-Control-Allow-Origin: http://yourothersite.com
Access-Control-Allow-Headers: Content-Type, Content-Range, Content-Disposition, Content-Description
            </code></pre>
        </section>

        <section>
            <section>
                <h2 style="text-transform: none;">XMLHttpRequest(s)</h2>
                <p>First XMLHttpRequest (~2006)</p>
                <p>XMLHttpRequest 2 already has 90% support</p>
                <p>XMLHttpRequest 2 isn't HTML5</p>
                <p>...</p>
            </section>
            <section>
                <h2>File API</h2>
                <p style="color: #060">Browser support: 89%+</p>
                <ul>
                    <li><b>File</b> - readonly attributes of file on disk</li>
                    <li><b>FileList</b> - list of File objects ~ &lt;input type="file" multiple&gt;</li>
                    <li><b>Blob</b> - raw binary data, access to range of bytes</li>
                    <li><b>FileReader</b> - interface/events for reading Files and Blobs</li>
                </ul>
            </section>
            <section>
                <h4>File API support check</h4>
                <pre><code class="javascript" data-trim>
if (window.File && window.FileReader && window.FileList && window.Blob) {
    // Great success! All the File APIs are supported.
} else {
    // This is the code you will throw away... someday
}
                </code></pre>
            </section>
        </section>


        <section>
            <section>
                <h2>HTML5 FormData</h2>
                    <pre><code class="html" data-trim>
<form method="POST" action="/upload" enctype="multipart/form-data">
    <input type="file" id="myfile" name="myfile">
    <input type="submit" value="Upload" name="submit">
</form>
                    </code></pre>
                    <pre><code class="javascript" data-trim>
var fd = new FormData();
fd.append('myfile', input.files[0]);

var xhr = new XMLHttpRequest();
xhr.onload = function() {
    alert("File uploaded!");
};
xhr.open("POST", "/upload");
xhr.send(fd);
                    </code></pre>
            </section>
            <section>
                <h4>Upload progress</h4>
                <div style="font-size: 0.7em; color: #060;">Browser support: 86%+</div>
                <pre><code class="html" style="font-size: 0.7em;" data-trim>
<form method="POST" action="/upload" enctype="multipart/form-data" id="myform">
    <input type="file" id="myfile" name="myfile">
    <input type="submit" value="Upload" name="submit">
</form>
<progress id="myprogress" max="100" value="0"></progress>
                </code></pre>
                <pre><code class="javascript stretch" style="font-size: 0.7em;" data-trim>
var myform = document.getElementById('myform');
var myprogress = document.getElementById('myprogress');
myform.addEventListener("submit", function handleFormSubmit(e) {
    e.preventDefault();
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
        alert("File uploaded!");
    };
    xhr.upload.onprogress = function(pe) {  // Progress Event!!
        if (pe.lengthComputable) {
            myprogress.value = (pe.loaded / pe.total) * 100;
            myprogress.textContent = myprogress.value;  // Fallback
        }
    };
    xhr.open(myform.method, myform.action);
    xhr.send(new FormData(myform));
}, false);
                </code></pre>
            </section>
            <section>
                <h2>Upload file by chunks</h2>
                <pre><code class="javascript stretch" data-trim>
function upload(blobOrFile) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/server', true);
    xhr.onload = function(e) { ... };
    xhr.send(blobOrFile);
}
var input = document.getElementById('myfile');
input.addEventListener('change', function(e) {
    var blob = this.files[0];
    const BYTES_PER_CHUNK = 1024 * 1024;  // 1MB chunk sizes.
    const SIZE = blob.size;
    var start = 0;
    var end = BYTES_PER_CHUNK;

    while(start < SIZE) {
        upload(blob.slice(start, end));
        start = end;
        end = start + BYTES_PER_CHUNK;
    }
}, false);
                </code></pre>
            </section>
        </section>

        <section>
            <h2>Security</h2>
            <p><code>&lt;input type=file /&gt;</code> is readonly after selecting the file in >= IE8, for security reasons</p>
        </section>

        <section>
            <h2>...</h2>
            <p>
                Progress bars <br>
                Uploading whole folders <br>
                Is file upload resume possible? <br>
                Immediate preview: http://www.javascripture.com/FileReader <br>
                File upload through WebSockets API <br>
                jquery File upload plugin <br>
                microlibs <br>
            </p>
        </section>

        <section>
            <h2>Ideas for future talks</h2>
            <p>
                <b>HTTP/2</b>
                <small>Pushing content, performance (minification/merging requests)</small>
            </p>
            <p>
                <b>WebRTC</b>
                <small>Web Real-Time Communication: voice, video, p2p file sharing</small>
            </p>
            <p>
                <b>WebSockets Upload</b>
                <small>Using sockets to upload files and their chunks</small>
            </p>
            <p>...</p>
        </section>

        <section>
            <h2>Resources</h2>
            <p>https://github.com/blueimp/jQuery-File-Upload/wiki/Browser-support</p>
            <p>http://www.html5rocks.com/en/tutorials/file/xhr2/</p>
        </section>
    </div>

</div>

<script src="/bower_components/reveal.js/lib/js/head.min.js"></script>
<script src="/bower_components/reveal.js/js/reveal.js"></script>

<script>
    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
            { src: '/bower_components/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
            { src: '/bower_components/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: '/bower_components/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: '/bower_components/reveal.js/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } }
        ]
    });

</script>

</body>
</html>
